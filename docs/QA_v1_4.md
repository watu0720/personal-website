# QA v1.4（お知らせ + リッチエディタ拡張 + 外部API安定化 + ストレージ棚卸し）

## お知らせ機能

### お知らせ一覧（/news）

- [ ] `/news` に公開記事の一覧が表示されること
- [ ] ページネーションが機能し、20件/ページで表示されること
- [ ] ページ番号や「前へ」「次へ」ボタンが表示されること
- [ ] URLクエリパラメータ（`?page=1&tag=...&q=...`）でページ/タグ/検索が管理されること
- [ ] タグフィルタが機能し、複数タグのOR条件でフィルタリングされること
- [ ] 検索機能（タイトル/本文の部分一致）が機能すること
- [ ] 各記事にサムネイル画像が表示されること（設定されている場合）
- [ ] 各記事に更新日時が表示されること
- [ ] 各記事にタグが表示されること
- [ ] 直近2週間（updated_at基準）の記事にNEWバッジが表示されること
- [ ] 記事をクリックすると詳細ページに遷移すること

### お知らせ詳細（/news/[id]）

- [ ] `/news/[id]` で記事詳細が表示されること
- [ ] タイトル、更新日時、タグが表示されること
- [ ] サムネイル画像が表示されること（設定されている場合）
- [ ] 本文（HTML）が正しく表示されること
- [ ] リンクプレビューが本文内のリンクの直下に表示されること
- [ ] 下書き記事は管理者のみ閲覧可能であること（一般ユーザーは404）
- [ ] 公開記事は全員閲覧可能であること
- [ ] 記事下部にコメント欄が表示されること

### Homeページ表示

- [ ] Homeページにお知らせセクションが表示されること
- [ ] 最新5件の公開記事が表示されること
- [ ] 各記事にNEWバッジが表示されること（直近2週間の場合）
- [ ] 「もっと見る」リンクで `/news` に遷移すること
- [ ] お知らせが0件の場合、セクションが非表示になること

### タグ機能

- [ ] タグは自由入力で追加できること
- [ ] タグ入力時に既存タグのサジェストが表示されること
- [ ] タグは複数追加できること（chip形式）
- [ ] タグを削除できること
- [ ] お知らせ一覧でタグフィルタが機能すること

## 管理者画面：お知らせ管理

### お知らせ一覧・管理

- [ ] 管理者画面に「お知らせ管理」メニューが表示されること
- [ ] お知らせ一覧が表示されること（下書き/公開のフィルタ可能）
- [ ] 各記事に編集・公開/下書き切替・削除ボタンが表示されること
- [ ] 記事をクリックすると詳細ページ（プレビュー）が開くこと

### お知らせ作成・編集

- [ ] 「新規作成」ボタンで新規作成フォームが表示されること
- [ ] タイトル（必須）を入力できること
- [ ] 本文（TinyMCE、必須）を編集できること
- [ ] サムネイルURL（任意）を入力できること
- [ ] タグ（任意、複数）を追加・削除できること
- [ ] 公開状態（draft/published）を選択できること
- [ ] 公開日時（任意）を設定できること
- [ ] 「保存」ボタンで保存できること
- [ ] 保存成功時にメッセージが表示されること
- [ ] 保存失敗時にエラーメッセージが表示されること

### 公開/下書き切替

- [ ] 公開記事を下書きに変更できること
- [ ] 下書き記事を公開に変更できること
- [ ] 公開に変更時に `published_at` が自動設定されること（未設定の場合）

### 削除機能

- [ ] 削除ボタンで確認ダイアログが表示されること
- [ ] 削除実行で論理削除（`deleted_at`設定）されること
- [ ] 削除後、一覧から非表示になること

## TinyMCE画像アップロード

- [ ] TinyMCEエディタに画像挿入ボタンが表示されること
- [ ] 画像アップロードボタンでファイル選択ダイアログが開くこと
- [ ] 画像を選択してアップロードできること
- [ ] アップロード先が `news` バケットであること
- [ ] 画像パスが `news/<news_id>/inline-*.png` 形式であること
- [ ] 同名上書きが可能であること
- [ ] アップロードした画像がエディタに挿入されること
- [ ] 画像URLにキャッシュバスター（`?v=<timestamp>`）が付くこと

## 記事プレビュー機能

- [ ] 編集画面に「プレビュー」ボタンが表示されること
- [ ] 「プレビュー」ボタンでプレビューモードに切り替わること
- [ ] プレビューでタイトル、本文が本番と同じ形式で表示されること
- [ ] プレビューでリンクプレビューが表示されること
- [ ] 「編集に戻る」ボタンで編集モードに戻れること

## リンクプレビュー機能

### リンク検出・表示

- [ ] 記事本文内のリンクが検出されること
- [ ] 対象URL（YouTube/Nico/X/GitHub）がカード表示されること
- [ ] リンクカードにタイトル、説明、画像が表示されること
- [ ] リンクカードをクリックすると該当URLに遷移すること
- [ ] リンクの直下にプレビューカードが挿入されること（note風）

### プレビュー取得

- [ ] YouTubeのリンクが正しくカード表示されること
- [ ] ニコニコ動画のリンクが正しくカード表示されること
- [ ] X(Twitter)のリンクが正しくカード表示されること
- [ ] GitHubのリンクが正しくカード表示されること
- [ ] OGP取得が機能すること（可能な場合）
- [ ] 取得失敗時は簡易表示（ドメイン+タイトル未取得）にフォールバックすること

### キャッシュ機能

- [ ] `link_previews` テーブルにキャッシュが保存されること
- [ ] 同じURLで毎回外部fetchしないこと
- [ ] キャッシュのTTLが機能すること（成功: 24時間、失敗: 10分）
- [ ] キャッシュ期限切れ後に再取得されること

## お知らせコメント機能

- [ ] 各お知らせ記事にコメント欄が表示されること
- [ ] `page_key` が `news:<news_id>` 形式であること
- [ ] 最新20件の親コメントが表示されること
- [ ] 21件以上の場合、コメントログへの導線が表示されること
- [ ] コメントログ `/comments/news:<news_id>` が機能すること
- [ ] 記事一覧（/news）にはコメントを置かないこと

## 外部API安定化

### 管理画面：手動更新

- [ ] 管理画面ダッシュボードに「外部APIキャッシュ更新」セクションが表示されること
- [ ] 「今すぐ更新」ボタンが表示されること
- [ ] ボタンをクリックするとキャッシュが更新されること
- [ ] 更新中は「更新中...」と表示されること
- [ ] 更新成功時にメッセージが表示されること
- [ ] 更新失敗時にエラーメッセージが表示されること
- [ ] 更新後にページがリロードされること

### 状態表示

- [ ] 最終更新時刻が表示されること（可能な場合）
- [ ] 直近の取得結果（成功/失敗）が表示されること
- [ ] 失敗時のエラーメッセージが表示されること（短縮）

## ストレージ棚卸し機能

### 未参照画像の検出

- [ ] ストレージ整理画面で「プレビューを取得」ボタンが表示されること
- [ ] プレビュー取得で未参照画像の候補が表示されること
- [ ] 未参照画像の定義が正しいこと：
  - `profiles.avatar_url` / `header_url` に一致しない
  - `news.thumbnail_url` に一致しない
  - `news` 本文内の画像URLに一致しない
- [ ] 直近7日以内にアップロードされた画像は除外されること（誤判定防止）

### ログ削除

- [ ] 期間指定（日付）でログ削除対象を指定できること
- [ ] 削除対象の件数がプレビューで表示されること
- [ ] 削除実行前に件数プレビューが出ること

### 削除実行

- [ ] 「削除を実行」ボタンが表示されること
- [ ] 削除実行で未参照画像が削除されること
- [ ] 削除実行で古いログが削除されること
- [ ] 削除結果（件数）が表示されること
- [ ] エラーが発生した場合、エラーメッセージが表示されること

### お知らせ画像対応

- [ ] `news` バケットの画像も未参照検出の対象になること
- [ ] お知らせのサムネイル画像が参照として認識されること
- [ ] お知らせ本文内の画像が参照として認識されること

## DB変更

- [ ] `news_posts` テーブルが作成されていること
- [ ] `link_previews` テーブルが作成されていること
- [ ] RLSポリシーが正しく設定されていること：
  - `news_posts`: publishedのみpublic、draftはadminのみ
  - `link_previews`: public select OK
- [ ] インデックスが作成されていること：
  - `idx_news_posts_status_updated`
  - `idx_news_posts_tags`
  - `idx_link_previews_url`

## Storage bucket

- [ ] Supabase Dashboardで `news` バケットが作成されていること
- [ ] バケットが公開設定になっていること（記事表示のため）

## 受入条件（v1.4 Done）

### お知らせ

- [ ] `/news` に一覧が表示され、Homeに最新5件が表示される
- [ ] 「もっと見る」で `/news` に遷移
- [ ] 直近2週間（updated_at基準）の記事に NEW が付く
- [ ] タグ表示とタグフィルタが動く
- [ ] `/news/[id]` で詳細が表示され、下書きはadminのみ

### 編集UI

- [ ] 管理者が news を作成/編集/公開/下書き切替できる
- [ ] TinyMCEで画像をアップロードして本文に挿入できる
- [ ] 編集画面でプレビュー表示ができる（本文とリンクプレビュー含む）

### リンクプレビュー

- [ ] 対象URL（YouTube/Nico/X/GitHub）がカード表示される
- [ ] 取得失敗時は簡易表示にフォールバックする
- [ ] キャッシュが機能する（同じURLで毎回外部fetchしない）

### コメント

- [ ] 各news記事にコメント欄があり、最新20件表示
- [ ] 21件以上でコメントログ導線が出る

### 外部API安定化

- [ ] 管理画面に「今すぐ更新」ボタンがあり、最終更新時刻/成功失敗が見える

### ストレージ棚卸し

- [ ] 未参照画像/古いログを管理者が一覧確認して削除できる
- [ ] 削除前に件数プレビューが出る
